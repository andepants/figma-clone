# Stripe Webhook Setup & Testing Guide

Complete guide for setting up and testing the Stripe webhook integration for CanvasIcons subscription management.

## Overview

The webhook handler processes Stripe events to update user subscriptions in Firestore automatically when:
- Users complete payment (checkout.session.completed)
- Subscriptions renew (customer.subscription.updated)
- Subscriptions are cancelled (customer.subscription.deleted)
- Payments fail (invoice.payment_failed)

**Location:** `functions/src/index.ts` → `stripeWebhook` HTTP endpoint

---

## Prerequisites

1. **Stripe Account:** Test mode enabled
2. **Stripe CLI:** Installed locally ([installation guide](https://stripe.com/docs/stripe-cli))
3. **Firebase Functions:** Deployed or running locally
4. **Environment Variables:** Configured (see below)

---

## Environment Setup

### Local Development (.env.local)

Create or update `/Users/andre/coding/figma-clone/functions/.env.local`:

```bash
# Stripe API Keys (Test Mode)
STRIPE_TEST_SECRET_KEY=sk_test_xxx
STRIPE_SECRET_KEY=sk_test_xxx  # Same as above

# Stripe Price IDs
STRIPE_FOUNDERS_PRICE_ID=price_xxx  # Get from Stripe Dashboard
STRIPE_PRO_PRICE_ID=price_yyy       # Future pro tier

# Webhook Secret (Local Testing)
STRIPE_WEBHOOK_SECRET=whsec_xxx  # Generated by Stripe CLI

# Firebase Admin (if not already configured)
FIREBASE_PROJECT_ID=your-project-id
```

### Production Secrets (Firebase)

Set secrets for production deployment:

```bash
# Navigate to functions directory
cd /Users/andre/coding/figma-clone/functions

# Set Stripe secret key
firebase functions:secrets:set STRIPE_SECRET_KEY

# Set webhook secret (from Stripe Dashboard)
firebase functions:secrets:set STRIPE_WEBHOOK_SECRET
```

**Note:** Never commit API keys to version control!

---

## Webhook Endpoint

### Local Development URL
```
http://localhost:5001/YOUR-PROJECT-ID/us-central1/stripeWebhook
```

### Production URL (after deployment)
```
https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/stripeWebhook
```

**Replace** `YOUR-PROJECT-ID` with your actual Firebase project ID.

---

## Local Testing with Stripe CLI

### Step 1: Install Stripe CLI

**macOS (Homebrew):**
```bash
brew install stripe/stripe-cli/stripe
```

**Windows (Scoop):**
```bash
scoop bucket add stripe https://github.com/stripe/scoop-stripe-cli.git
scoop install stripe
```

**Linux:**
```bash
wget https://github.com/stripe/stripe-cli/releases/latest/download/stripe_linux_x86_64.tar.gz
tar -xvf stripe_linux_x86_64.tar.gz
sudo mv stripe /usr/local/bin/
```

### Step 2: Authenticate Stripe CLI

```bash
stripe login
```

This opens your browser to authenticate with your Stripe account.

### Step 3: Start Firebase Functions Emulator

In one terminal:

```bash
cd /Users/andre/coding/figma-clone/functions
npm run serve
```

This starts the Functions emulator at `http://localhost:5001`.

### Step 4: Forward Stripe Events to Local Endpoint

In another terminal:

```bash
stripe listen --forward-to localhost:5001/YOUR-PROJECT-ID/us-central1/stripeWebhook
```

**Output will include:**
```
> Ready! Your webhook signing secret is whsec_xxx (^C to quit)
```

**Important:** Copy the `whsec_xxx` secret and add it to your `.env.local`:

```bash
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

Restart the Functions emulator after updating `.env.local`.

### Step 5: Trigger Test Events

**Test checkout.session.completed:**
```bash
stripe trigger checkout.session.completed
```

**Test subscription lifecycle events:**
```bash
stripe trigger customer.subscription.updated
stripe trigger customer.subscription.deleted
stripe trigger invoice.payment_succeeded
stripe trigger invoice.payment_failed
```

**Check logs:**
- Terminal running Functions emulator shows webhook processing logs
- Check Firestore to verify user subscription was updated

---

## Manual Testing with Test Cards

### Step 1: Create Stripe Products (if not already done)

1. Go to [Stripe Dashboard → Products](https://dashboard.stripe.com/test/products)
2. Click "Add product"
3. **Founders Tier:**
   - Name: "CanvasIcons Founders Access"
   - Price: $9.99/year (recurring)
   - Metadata: `tier=founders`
4. Copy the Price ID (starts with `price_`)
5. Add to `.env.local` as `STRIPE_FOUNDERS_PRICE_ID`

### Step 2: Test Checkout Flow

1. **Start dev server:**
   ```bash
   cd /Users/andre/coding/figma-clone
   npm run dev
   ```

2. **Navigate to pricing page:**
   ```
   http://localhost:5173/pricing
   ```

3. **Sign in as test user** (or create new account)

4. **Click "Get Started" on Founders tier**
   - Should redirect to Stripe Checkout
   - **Important:** Make sure frontend is using test publishable key

5. **Use Stripe test card:**
   - Card number: `4242 4242 4242 4242`
   - Expiry: Any future date (e.g., 12/34)
   - CVC: Any 3 digits (e.g., 123)
   - ZIP: Any 5 digits (e.g., 12345)

6. **Complete payment**

7. **Verify webhook processing:**
   - Check terminal running Stripe CLI → Should see `checkout.session.completed` event
   - Check terminal running Functions emulator → Should see "Webhook event processed successfully"
   - Check Firestore → User document should have:
     ```json
     {
       "subscription": {
         "status": "founders",
         "stripeCustomerId": "cus_xxx",
         "stripePriceId": "price_xxx",
         "currentPeriodEnd": 1234567890,
         "cancelAtPeriodEnd": false
       }
     }
     ```

### Step 3: Test Subscription Updates

**Cancel subscription (will cancel at period end):**
1. Go to [Stripe Dashboard → Customers](https://dashboard.stripe.com/test/customers)
2. Find your test customer
3. Click on the subscription
4. Click "Cancel subscription" → "Cancel at end of period"
5. Check webhook logs → Should see `customer.subscription.updated`
6. Check Firestore → `cancelAtPeriodEnd` should be `true`

**Reactivate subscription:**
1. In Stripe Dashboard, click "Reactivate subscription"
2. Check webhook → `customer.subscription.updated`
3. Check Firestore → `cancelAtPeriodEnd` should be `false`

**Delete subscription immediately:**
1. Cancel subscription → "Cancel immediately"
2. Check webhook → `customer.subscription.deleted`
3. Check Firestore → `status` should be `"free"`

### Step 4: Test Payment Failures

**Test declining card:**
1. Go through checkout with card `4000 0000 0000 0341` (declines)
2. Initial checkout will fail (expected)
3. For renewal testing:
   - Update customer's payment method to declining card in Stripe Dashboard
   - Manually create invoice → `invoice.payment_failed` event
   - Check logs for failure handling

---

## Production Deployment

### Step 1: Deploy Functions

```bash
cd /Users/andre/coding/figma-clone/functions
npm run build
firebase deploy --only functions
```

**Output:**
```
✔  functions[stripeWebhook(us-central1)] Successful create operation.
Function URL: https://us-central1-YOUR-PROJECT-ID.cloudfunctions.net/stripeWebhook
```

Copy the Function URL.

### Step 2: Configure Webhook in Stripe Dashboard

1. Go to [Stripe Dashboard → Webhooks](https://dashboard.stripe.com/test/webhooks)
2. Click "Add endpoint"
3. **Endpoint URL:** Paste Function URL
4. **Events to send:**
   - Select "checkout.session.completed"
   - Select "customer.subscription.updated"
   - Select "customer.subscription.deleted"
   - Select "invoice.payment_failed"
   - Select "invoice.payment_succeeded"
5. Click "Add endpoint"

### Step 3: Get Webhook Signing Secret

1. After creating endpoint, click to view details
2. Copy "Signing secret" (starts with `whsec_`)
3. Add to Firebase secrets:
   ```bash
   firebase functions:secrets:set STRIPE_WEBHOOK_SECRET
   # Paste the whsec_xxx value when prompted
   ```

### Step 4: Redeploy with Secrets

```bash
firebase deploy --only functions
```

### Step 5: Test Production Webhook

1. Complete a test purchase in production
2. Go to Stripe Dashboard → Webhooks → Your endpoint
3. Click "Send test webhook"
4. Select "checkout.session.completed"
5. Check Firebase Functions logs:
   ```bash
   firebase functions:log --only stripeWebhook
   ```

---

## Webhook Events Reference

### checkout.session.completed

**Triggered when:** User completes payment successfully

**Action:**
- Extract user ID from `client_reference_id`
- Update user subscription to "founders" or "pro"
- Set `stripeCustomerId` and `currentPeriodEnd`

**Test:**
```bash
stripe trigger checkout.session.completed
```

### customer.subscription.updated

**Triggered when:**
- Subscription renews automatically
- User changes plan
- Subscription set to cancel at period end

**Action:**
- Update subscription status, price ID, period end
- Update `cancelAtPeriodEnd` flag

**Test:**
```bash
stripe trigger customer.subscription.updated
```

### customer.subscription.deleted

**Triggered when:**
- Subscription cancelled immediately
- Subscription period ends after cancellation

**Action:**
- Downgrade user to "free" tier
- Clear subscription details

**Test:**
```bash
stripe trigger customer.subscription.deleted
```

### invoice.payment_failed

**Triggered when:** Subscription renewal payment fails

**Action:**
- Log failure (Stripe retries automatically)
- Future: Send email notification to user

**Test:**
```bash
stripe trigger invoice.payment_failed
```

### invoice.payment_succeeded

**Triggered when:** Subscription payment succeeds

**Action:**
- Log success for analytics
- Subscription already updated via subscription.updated event

**Test:**
```bash
stripe trigger invoice.payment_succeeded
```

---

## Troubleshooting

### Webhook signature verification failed

**Cause:** Incorrect `STRIPE_WEBHOOK_SECRET` or raw body not preserved

**Solution:**
1. Verify secret matches Stripe Dashboard
2. Ensure Firebase Functions v2 is used (provides `req.rawBody`)
3. Check that body parsing middleware doesn't interfere

**Test:**
```bash
# Check secret in Stripe Dashboard
stripe webhooks list

# Test locally with Stripe CLI
stripe listen --forward-to localhost:5001/...
```

### User not found for customer ID

**Cause:** No user document with matching `stripeCustomerId`

**Solution:**
1. Ensure checkout passes `client_reference_id` (user ID)
2. Verify `checkout.session.completed` handler creates customer ID mapping
3. Check Firestore query index if using multiple fields

**Debug:**
```javascript
// In Firestore Console, query:
db.collection('users').where('subscription.stripeCustomerId', '==', 'cus_xxx')
```

### Subscription status not updating in frontend

**Cause:** Frontend polling not working or Firestore cache

**Solution:**
1. Check frontend code polls for subscription update after payment
2. Clear Firestore cache: `localStorage.clear()` in browser console
3. Verify webhook processed successfully in Functions logs

### TypeScript errors about Stripe properties

**Cause:** Stripe TypeScript definitions may be outdated

**Solution:**
- Code uses `(subscription as any).current_period_end` workaround
- Properties exist at runtime, safe to use
- TODO: Update when Stripe types are fixed

---

## Monitoring & Logs

### View Firebase Functions logs

```bash
# All functions
firebase functions:log

# Only webhook
firebase functions:log --only stripeWebhook

# Follow live logs
firebase functions:log --only stripeWebhook --follow
```

### View Stripe webhook logs

1. Go to [Stripe Dashboard → Webhooks](https://dashboard.stripe.com/test/webhooks)
2. Click your endpoint
3. View "Recent events" tab
4. Check for:
   - ✅ Successful (200 response)
   - ⚠️ Failed (400/500 response)

### Key log entries to look for

**Success:**
```
Webhook signature verified
Processing webhook event: checkout.session.completed
User subscription updated: { userId, tier: "founders" }
Webhook event processed successfully
```

**Failure:**
```
Webhook signature verification failed
User not found for customer ID
Failed to update user subscription
```

---

## Security Checklist

- [x] Webhook signature verification enabled
- [x] Secrets stored in Firebase secrets (not code)
- [x] `.env.local` in `.gitignore`
- [x] Test mode keys separate from production
- [x] HTTPS only (enforced by Firebase Functions)
- [x] Error messages don't leak sensitive data

---

## Next Steps

1. **Test all webhook events locally** with Stripe CLI
2. **Complete end-to-end payment flow** with test card
3. **Deploy to production** and configure webhook in Stripe Dashboard
4. **Monitor logs** for first 24 hours after deployment
5. **Set up email notifications** for payment failures (future enhancement)

---

## Support Resources

- **Stripe Webhooks Guide:** https://stripe.com/docs/webhooks
- **Stripe CLI Docs:** https://stripe.com/docs/stripe-cli
- **Firebase Functions Secrets:** https://firebase.google.com/docs/functions/config-env
- **Test Cards:** https://stripe.com/docs/testing

---

**Last Updated:** 2025-10-17
**Maintained by:** CanvasIcons Development Team
